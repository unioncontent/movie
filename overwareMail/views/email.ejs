<div class="main-body">
  <div class="page-wrapper">
    <div class="page-header">
      <div class="page-header-title">
        <h4>메일발송</h4>
      </div>
      <div class="page-header-breadcrumb">
        <ul class="breadcrumb-title">
          <li class="breadcrumb-item">
            <a href="/">
              <i class="fas fa-home"></i>
            </a>
          </li>
          <li class="breadcrumb-item"><a href="#!">메일발송</a></li>
        </ul>
      </div>
    </div>
    <div class="page-body">
      <div class="row">
        <div class="col-md-12">
          <div class="card">
            <div class="card-block">
              <div class="form-group row">
                <label class="col-sm-2 col-form-label">* 수신그룹</label>
                <div class="col-sm-4">
                  <input type="hidden" id="groupCheck"/>
                  <input id="M_group" type="text" class="form-control" placeholder="수신그룹">
                  <span class='messages'><p class='text-danger error'></p></span>
                </div>
                <div class="col-sm-1 btn-check1">
                  <button id="contentsBtn" type="button" class="btn btn-inverse alert-prompt">검색</button>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-2 col-form-label">* 보내는 사람</label>
                <div class="col-sm-4">
                  <input type="hidden" id="senderCheck"/>
                  <input id="M_sender" type="text" class="form-control" placeholder="보내는 사람">
                  <span class='messages'><p class='text-danger error'></p></span>
                </div>
                <div class="col-sm-1 btn-check2">
                  <button id="contentsBtn" type="button" class="btn btn-inverse alert-prompt">검색</button>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-2 col-form-label">* 받는 사람</label>
                <div class="col-sm-4">
                  <input type="hidden" id="recipiCheck"/>
                  <input id="M_recipi" type="text" class="form-control" placeholder="받는 사람">
                  <span class='messages'><p class='text-danger error'></p></span>
                </div>
                <div class="col-sm-1 btn-check3">
                  <button id="contentsBtn" type="button" class="btn btn-inverse alert-prompt">검색</button>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-2 col-form-label">* 키워드</label>
                <div class="col-sm-5">
                  <select id="M_keyword" name="select" class="col-sm-3 form-control form-control-inverse f-left m-r-10 m-b-10">
                    <option value="0">선택</option>
                  </select>
                  <select id="M_mail_type" name="select" class="col-sm-3 form-control form-control-inverse f-left m-r-10 m-b-10">
                    <option value="0">선택</option>
                  </select>
                  <span class='messages'><p class='text-danger error'></p></span>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-2 col-form-label">* 메일제목</label>
                <div class="col-sm-7">
                  <input id="M_subject" type="text" class="form-control" placeholder="메일제목">
                  <span class='messages'><p class='text-danger error'></p></span>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-2 col-form-label">* 메일내용</label>
                <div class="col-sm-7">
                  <div id="M_body"></div>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-2 col-form-label">첨부파일</label>
                <div class="col-sm-5">
                  <input type="file" id="M_file" name="files[]" multiple="multiple" class="form-control">
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-2 col-form-label">* 발송형태</label>
                <div id="type" class="form-radio">
                  <div class="col-sm-12">
                    <div class="radio radio-inline">
                      <label>
                        <input type="radio" value="0" name="M_type" checked>
                        <i class="helper"></i>즉시
                      </label>
                    </div>
                    <div class="radio radio-inline">
                      <label>
                        <input type="radio" value="1" name="M_type">
                        <i class="helper"></i>예약
                      </label>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row">
                <label class="col-sm-2"></label>
                <div class="col-sm-10">
                    <button id="sendBtn" type="submit" class="btn btn-inverse m-b-0">등록</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- filer -->
<link rel="stylesheet" type="text/css" href="/css/jquery.filer.css">
<script type="text/javascript" src="/js/jquery.filer.min.js"></script>
<!-- editor -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.9/summernote-lite.css" rel="stylesheet">
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.9/summernote-lite.js"></script>
<script type="text/javascript" src="/js/summernote-ko-KR.js"></script>
<!-- alert -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sweetalert@2.1.0/dist/sweetalert.min.js"></script>
<style>
  .dropdown-toggle::after{
    display: none;
  }
  .note-editor .note-editing-area .note-editable table td,
  .note-editor .note-editing-area .note-editable table th{
    border: 1px solid #252525;
  }
  .jFiler-theme-default .jFiler-input {
    width: 100%;
    height: 41px;
  }
  .jFiler-theme-default .jFiler-input-caption,
  .jFiler-theme-default .jFiler-input-button{
    padding-top: 10px;
  }
</style>
<script type="text/javascript">
  $(document).ready(function() {
    $('#M_body').summernote({
      lang: 'ko-KR',
      tabsize: 2,
      height: 300,
      toolbar: [
        ['style', ['style']],
        ['style', ['bold', 'italic', 'underline', 'clear']],
        ['font', ['fontname']],
        ['fontsize', ['fontsize']],
        ['height', ['height']],
        ['color', ['color']],
        ['para', ['ul', 'ol', 'paragraph']],
        ['table', ['table']],
        ['insert', ['picture','link']],
        ['Misc',['fullscreen','codeview','help']]
      ],
      callbacks: {
        onImageUpload : function(file, editor, welEditable) {
          saveImgFile(file[0], editor, welEditable);
        }
      }
    });
    // $('#M_file').filer({
  	// 	showThumbs: true,
  	// 	addMore: true,
  	// 	allowDuplicates: false
  	// });
    $('#M_file').filer({
      limit: '5',
      maxSize: '10',
      changeInput: true,
      showThumbs: true,
      uploadFile: {
        url: "/email/send/files",
        data: {},
        type: 'POST',
        enctype: 'multipart/form-data',
        beforeSend: function(){},
        success: function(data, el){
          var parent = el.find(".jFiler-jProgressBar").parent();
          el.find(".jFiler-jProgressBar").fadeOut("slow", function(){
            $("<div class=\"jFiler-item-others text-success\"><i class=\"icon-jfi-check-circle\"></i> Success</div>").hide().appendTo(parent).fadeIn("slow");
          });
        },
        error: function(el){
          var parent = el.find(".jFiler-jProgressBar").parent();
          el.find(".jFiler-jProgressBar").fadeOut("slow", function(){
            $("<div class=\"jFiler-item-others text-error\"><i class=\"icon-jfi-minus-circle\"></i> Error</div>").hide().appendTo(parent).fadeIn("slow");
          });
        },
        statusCode: {},
        onProgress: function(){},
      },
      dragDrop: {
        dragEnter: null,
        dragLeave: null,
        drop: null,
      },
      addMore: true,
      clipBoardPaste: true,
      excludeName: null,
      beforeShow: function(){return true},
      onSelect: function(){},
      afterShow: function(){},
      onRemove: function(){},
      onEmpty: function(){},
      captions: {
        button: "등록",
        feedback: "첨부할 파일을 선택해주세요.",
        feedback2: "파일이 선택되었습니다.",
        // drop: "Drop file here to Upload",
        removeConfirmation: "이 파일을 제거 하시겠습니까??",
        errors: {
          filesLimit: "{{fi-limit}} 개의 파일만 업로드 할 수 있습니다.",
          // filesType: "Only Images are allowed to be uploaded.",
          filesSize: "{{fi-name}} 이 너무 큽니다! 파일은 최대 {{fi-maxSize}} MB까지 첨부 가능합니다.",
          filesSizeAll: "선택하신 파일이 너무 큽니다! 첨부파일의 전체 합 {{fi-maxSize}} MB까지 첨부 가능합니다."
        }
      }
    });
  });
  function saveImgFile(file){
    console.log('saveImgFile:',file);
    data = new FormData();
    data.append("file", file);
    $.ajax({
      type: "POST",
      url: "/email/send/img",
      data: data,
      cache: false,
      contentType : false,
      processData : false,
      success: function(data) {
        console.log('success:',data);
        $('#M_body').summernote('insertImage', 'http://localhost:3000//uploads/'+data);
      }
    });
  }
  $(document).on("click",".jFiler-item-trash-action",function(){
    console.log($(this));
  });
  $("#sendBtn").on("click",function(){
    swal({
      title: "메일 보내시겠습니까?",
      icon: "warning",
      buttons: ["취소", true],
      dangerMode: true,
    })
    .then((value) => {
      if (value != null) {
        var check=true;
        var param = {
          'M_group': $('#M_group').val(),
          'M_sender': $("#M_sender").val(),
          'M_recipi': $("#M_recipi").val(),
          'M_keyword': $("#M_keyword option:selected").val(),
          'M_mail_type': $("#M_mail_type option:selected").val(),
          'M_subject': $("#M_subject").val(),
          'M_body': $("#M_body").summernote('code'),
          'M_file': $("#M_file").val(),
          'M_type': $("input:radio[name=M_type]:checked").val(),
        };
        if(param["M_group"] == ""){
          check = requiredMessage("M_group","수신그룹을 입력해주세요.");
        }
        if(param["M_sender"] == ""){
          check = requiredMessage("M_sender","보내는 사람를 입력해주세요.");
        }
        if(param["M_recipi"] == ""){
          check = requiredMessage("M_recipi","받는사람을 입력해주세요.");
        }
        if(param["M_keyword"] == ""){
          check = requiredMessage("M_keyword","키워드를 선택해주세요.");
        }
        if(param["M_mail_type"] == ""){
          check = requiredMessage("M_mail_type","메일타입을 선택해주세요.");
        }
        if(param["M_subject"] == ""){
          check = requiredMessage("M_subject","메일제목을 입력해주세요.");
        }
        if(param["M_body"] == ""){
          check = requiredMessage("M_body","메일내용 입력해주세요.");
        }
        if(param["M_type"] == ""){
          check = requiredMessage("M_type","발송타입을 선택해주세요.");
        }
        console.log(param);
        SendEmails(param);
      }
    });
  });
  function requiredMessage(target,msg){
    $("#"+target).siblings().children().text(msg);
    $("#"+target).addClass("form-control-danger");
    return false;
  }
  function SendEmails(param){
    $.ajax({
      url: '/email/send',
      type: 'post',
      data : param,
      datatype : 'json',
      error:function(request,status,error){
        console.log('code:'+request.status+'\n'+'message:'+request.responseText+'\n'+'error:'+error);
        swal("ERROR!", "메일발송 실패했습니다. 다시 시도해주세요.", "error");
      },
      success:function(data){
        swal("SUCCESS!", "메일발송 성공했습니다.", "success");
        // window.location.reload();
      }
    });
  }
  $("input, select").on("focus",function(){
    $(this).removeClass("form-control-danger");
    $(this).siblings().children("p").text("");
  });
  $("#insertBtn2").on("click",function(){
    if($('input[type=file]').val()==""){
      alert('파일을 선택해주세요.');
      return false;
    }
    $("#uploadFrm").submit();
  });
</script>
